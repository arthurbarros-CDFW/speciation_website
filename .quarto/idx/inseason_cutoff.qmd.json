{"title":"In-season Cutoff","markdown":{"yaml":{"title":"In-season Cutoff","bibliography":"references/references.bib","link-citations":true},"headingText":"Calculate proportions and reshape in one step","containsRefs":false,"markdown":"\n\nPerhaps the simplest method to speciate between two different fish\nspecies in a study would be to incorporate historical run-time and\ncatch/escapement data proximate to the sonar study area in a method we\ncan refer to as an \"in-season cutoff\"[@Nolan2023]. Here we'll simulate\nsome historical auxiliary count data for two different species, \"A\" and\n\"B\", using the same methods as above to get the following `weekly_aux`\ndata.\n\n```{r,echo=FALSE,message=FALSE,warning=FALSE}\nlibrary(tidyverse) #for piping and data formatting ease\nlibrary(ggplot2) #for plotting\nlibrary(lubridate) #makes formatting dates a little easier\nlibrary(caret) #provides the createDataPartition() call for testing/training\nlibrary(nnet) #for multi-nomial regression\nlibrary(mclust) #for gaussian mixed models\n\ndaily_sonar<-readRDS(\"data/daily_sonar.rds\")\n```\n\n```{r, aux_sim_historic, ,message=FALSE,warning=FALSE,echo=FALSE}\n#1) Identify peaks\nh_peakA <- as.numeric(as.Date(\"2009-11-10\"))\nh_peakB <- as.numeric(as.Date(\"2010-01-12\"))\n\n#2) Simulate counts around the peaks using normal distributions\nset.seed(123)  # For reproducibility\nh_countsA <- round(rnorm(400, mean = h_peakA, sd = 20))\nh_countsB <- round(rnorm(325, mean = h_peakB, sd = 22))\n\n#3) Create dataframes with counts\nh_countsA <- as.data.frame(table(as.Date(h_countsA, origin = \"1970-01-01\")))\nh_countsB <- as.data.frame(table(as.Date(h_countsB, origin = \"1970-01-01\")))\nnames(h_countsA) <- c(\"date\", \"Count\")\nnames(h_countsB) <- c(\"date\", \"Count\")\n\n#4) Add species column\nh_countsA$species <- \"A\"\nh_countsB$species <- \"B\"\n\n#5) Combine both dataframes\ndate_counts <- rbind(h_countsA, h_countsB)\n\n#6) Convert date column to date type\ndate_counts$date <- as.Date(date_counts$date)\n\n#7) Bin the dates by week\ndate_counts$Week <- cut(date_counts$date, breaks = \"week\",\n                        start.on.monday = TRUE)\n\n#8) Aggregate the counts by week and species\nweekly_aux <- date_counts %>%\n  group_by(Week, species) %>%\n  summarise(Total_Count = sum(Count)) %>%\n  ungroup()\n\n#9) Convert Week back to Date for plotting\nweekly_aux$Week <- as.Date(weekly_aux$Week)\n\n```\n\n```{r,sim_hatchery data overview}\nhead(weekly_aux)\n```\n\nThis auxiliary data set shows the weekly counts of our two target\nspecies for a run 13 years prior to our sonar data at a proximate\nlocation. Obviously a more proximate (in both space and time) auxiliary\ndata set could be more representative of our sonar samples, and thus\nmore applicable. However, often the auxiliary data available is not the\nmost optimal, and so we have to use the best data available.\n\nThis historical data set can be used to produce an \"in-season cutoff\",\nessentially finding a date in the historical data when the proportion of\nspecies B is greater than species A. We can then apply that date to our\nsonar data, and assign any fish observed before that date as \"A\" and\nafter as \"B\". To utilize an \"in-season cutoff\" we need to find the week\nwhen the proportion of species B captured was higher than the count of\nspecies A. We can use the following code to first estimate the\nproportion of each species for each week fish were caught:\n\n```{r, find cutoff_1}\nproportions_combined <- weekly_aux %>%\n  group_by(Week) %>%\n  mutate(total_n = sum(Total_Count)) %>%\n  mutate(proportion = Total_Count / total_n) %>%\n  select(Week, species, proportion) %>%\n  pivot_wider(names_from = species,\n              values_from = proportion,\n              names_prefix = \"proportion_\") %>%\n  ungroup()\n\n```\n\nNow we can easily find the first week in our data when the count of\nspecies B is greater than species A.\n\n```{r}\n# Find the first week where the proportion of species A is greater than B\nresult <- proportions_combined %>%\n  filter(proportion_B > proportion_A) %>%\n  slice(1)\n\nresult_week <- result$Week\n\n# Output the first week\nresult_week\n```\n\nThe above shows us that `r result_week` was the first week in which the\ncount of species B was greater than the count of A in our auxiliary\ndata.\n\nWe can plot the distribution of the data here along with our cutoff:\n\n```{r,hatchery_sim_plot_historic,echo=FALSE, fig.cap = \"Plot showing species counts of auxiliary historical hatchery data set. Dashed line represents 'in-season cutoff'.\"}\n# Plot the results\nggplot(weekly_aux, aes(x = Week, y = Total_Count, fill = species)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  labs(title = \"Simulated Historical Auxiliary Data\",\n       x = \"Week\",\n       y = \"Count\") +\n  geom_vline(xintercept = (result_week-3.5),linetype='dashed')+\n  scale_fill_manual(values = c('darkorange2','cyan3'),\n                    labels = c('A','B'))+\n  #scale_x_date(date_labels = \"%Y-%m\", date_breaks = \"1 month\") +\n  theme_classic()\n\n```\n\nUsing this historical auxiliary data set, we can decide to set our\ncutoff to the date of `r result_week`, and assign any fish detection in\nour sonar data before that date as species A, and any after as species\nB.\n\n```{r,cutoff_assign}\ntarget_year<-2023\ncutoff_date<-as.Date(paste(target_year,\n                           month(result_week),day(result_week),sep=\"-\"))\n\ndaily_sonar<-daily_sonar\ndaily_sonar$predicted_species<-\n  ifelse(daily_sonar$date<cutoff_date,'A','B')\n```\n\nWe can now plot our sonar data and show the species assignments.\n\n```{r,cutoff_assign_plot,echo=FALSE, fig.cap = \"Plot showing species assignments of sonar data using the 'In-season cutoff' method\"}\n# Plot the results\nggplot(daily_sonar, aes(x = Week, y = Net_Movement,\n                                 fill = predicted_species)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  labs(title = \"Speciated Sonar Movement Counts\",\n       x = \"Week\",\n       y = \"Net Movement\") +\n  geom_vline(xintercept = (cutoff_date-3.5),linetype='dashed')+\n  scale_fill_manual(values = c('maroon','darkgreen'), labels = c('A','B'))+\n  #scale_x_date(date_labels = \"%Y-%m\", date_breaks = \"1 month\") +\n  theme_classic()\n```\n\nFinally we can estimate counts for each species in our sonar data.\n\n```{r,cutoff_estimate}\nN_est<-daily_sonar%>%\n  group_by(predicted_species)%>%\n  summarise(total=sum(Net_Movement))\n```\n\nWith the above snippet we can see that our final estimates of sonar\ncounts are `r N_est[1,2]` for species A and `r N_est[2,2]` for species\nB. We know that our simulated data had a count of `r sum(daily_sonar$species==\"A\")` for\nspecies A and `r sum(daily_sonar$species==\"B\")` for species B, so we had an error rate\nof `r 100*(1-(N_est[1,2]/sum(daily_sonar$species==\"A\")))`%.\n\nThe above method of speciation, while simple, provides a straightforward\napproach for leveraging historical data to infer species composition in\nsonar detection studies. Key assumptions to realize when utilizing this\nmethod are:\n\n-   All fish being speciated are either one of two species.\n\n-   There is no overlap in run timing.\n\n-   Date based threshold of the auxiliary data is representative of the\n    sonar site.\n\n-   Date based threshold used is consistent between years.\n\nReal world systems will likely violate one or more of the above\nassumptions, so the use of this method is likely to bias species\nidentifications and resulting count estimates. Our simulation had an\noverlap in run timing and variation in the distributions that resulted\nin an over-count of species B and an under-count of species A.\n \n","srcMarkdownNoYaml":"\n\nPerhaps the simplest method to speciate between two different fish\nspecies in a study would be to incorporate historical run-time and\ncatch/escapement data proximate to the sonar study area in a method we\ncan refer to as an \"in-season cutoff\"[@Nolan2023]. Here we'll simulate\nsome historical auxiliary count data for two different species, \"A\" and\n\"B\", using the same methods as above to get the following `weekly_aux`\ndata.\n\n```{r,echo=FALSE,message=FALSE,warning=FALSE}\nlibrary(tidyverse) #for piping and data formatting ease\nlibrary(ggplot2) #for plotting\nlibrary(lubridate) #makes formatting dates a little easier\nlibrary(caret) #provides the createDataPartition() call for testing/training\nlibrary(nnet) #for multi-nomial regression\nlibrary(mclust) #for gaussian mixed models\n\ndaily_sonar<-readRDS(\"data/daily_sonar.rds\")\n```\n\n```{r, aux_sim_historic, ,message=FALSE,warning=FALSE,echo=FALSE}\n#1) Identify peaks\nh_peakA <- as.numeric(as.Date(\"2009-11-10\"))\nh_peakB <- as.numeric(as.Date(\"2010-01-12\"))\n\n#2) Simulate counts around the peaks using normal distributions\nset.seed(123)  # For reproducibility\nh_countsA <- round(rnorm(400, mean = h_peakA, sd = 20))\nh_countsB <- round(rnorm(325, mean = h_peakB, sd = 22))\n\n#3) Create dataframes with counts\nh_countsA <- as.data.frame(table(as.Date(h_countsA, origin = \"1970-01-01\")))\nh_countsB <- as.data.frame(table(as.Date(h_countsB, origin = \"1970-01-01\")))\nnames(h_countsA) <- c(\"date\", \"Count\")\nnames(h_countsB) <- c(\"date\", \"Count\")\n\n#4) Add species column\nh_countsA$species <- \"A\"\nh_countsB$species <- \"B\"\n\n#5) Combine both dataframes\ndate_counts <- rbind(h_countsA, h_countsB)\n\n#6) Convert date column to date type\ndate_counts$date <- as.Date(date_counts$date)\n\n#7) Bin the dates by week\ndate_counts$Week <- cut(date_counts$date, breaks = \"week\",\n                        start.on.monday = TRUE)\n\n#8) Aggregate the counts by week and species\nweekly_aux <- date_counts %>%\n  group_by(Week, species) %>%\n  summarise(Total_Count = sum(Count)) %>%\n  ungroup()\n\n#9) Convert Week back to Date for plotting\nweekly_aux$Week <- as.Date(weekly_aux$Week)\n\n```\n\n```{r,sim_hatchery data overview}\nhead(weekly_aux)\n```\n\nThis auxiliary data set shows the weekly counts of our two target\nspecies for a run 13 years prior to our sonar data at a proximate\nlocation. Obviously a more proximate (in both space and time) auxiliary\ndata set could be more representative of our sonar samples, and thus\nmore applicable. However, often the auxiliary data available is not the\nmost optimal, and so we have to use the best data available.\n\nThis historical data set can be used to produce an \"in-season cutoff\",\nessentially finding a date in the historical data when the proportion of\nspecies B is greater than species A. We can then apply that date to our\nsonar data, and assign any fish observed before that date as \"A\" and\nafter as \"B\". To utilize an \"in-season cutoff\" we need to find the week\nwhen the proportion of species B captured was higher than the count of\nspecies A. We can use the following code to first estimate the\nproportion of each species for each week fish were caught:\n\n```{r, find cutoff_1}\n# Calculate proportions and reshape in one step\nproportions_combined <- weekly_aux %>%\n  group_by(Week) %>%\n  mutate(total_n = sum(Total_Count)) %>%\n  mutate(proportion = Total_Count / total_n) %>%\n  select(Week, species, proportion) %>%\n  pivot_wider(names_from = species,\n              values_from = proportion,\n              names_prefix = \"proportion_\") %>%\n  ungroup()\n\n```\n\nNow we can easily find the first week in our data when the count of\nspecies B is greater than species A.\n\n```{r}\n# Find the first week where the proportion of species A is greater than B\nresult <- proportions_combined %>%\n  filter(proportion_B > proportion_A) %>%\n  slice(1)\n\nresult_week <- result$Week\n\n# Output the first week\nresult_week\n```\n\nThe above shows us that `r result_week` was the first week in which the\ncount of species B was greater than the count of A in our auxiliary\ndata.\n\nWe can plot the distribution of the data here along with our cutoff:\n\n```{r,hatchery_sim_plot_historic,echo=FALSE, fig.cap = \"Plot showing species counts of auxiliary historical hatchery data set. Dashed line represents 'in-season cutoff'.\"}\n# Plot the results\nggplot(weekly_aux, aes(x = Week, y = Total_Count, fill = species)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  labs(title = \"Simulated Historical Auxiliary Data\",\n       x = \"Week\",\n       y = \"Count\") +\n  geom_vline(xintercept = (result_week-3.5),linetype='dashed')+\n  scale_fill_manual(values = c('darkorange2','cyan3'),\n                    labels = c('A','B'))+\n  #scale_x_date(date_labels = \"%Y-%m\", date_breaks = \"1 month\") +\n  theme_classic()\n\n```\n\nUsing this historical auxiliary data set, we can decide to set our\ncutoff to the date of `r result_week`, and assign any fish detection in\nour sonar data before that date as species A, and any after as species\nB.\n\n```{r,cutoff_assign}\ntarget_year<-2023\ncutoff_date<-as.Date(paste(target_year,\n                           month(result_week),day(result_week),sep=\"-\"))\n\ndaily_sonar<-daily_sonar\ndaily_sonar$predicted_species<-\n  ifelse(daily_sonar$date<cutoff_date,'A','B')\n```\n\nWe can now plot our sonar data and show the species assignments.\n\n```{r,cutoff_assign_plot,echo=FALSE, fig.cap = \"Plot showing species assignments of sonar data using the 'In-season cutoff' method\"}\n# Plot the results\nggplot(daily_sonar, aes(x = Week, y = Net_Movement,\n                                 fill = predicted_species)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  labs(title = \"Speciated Sonar Movement Counts\",\n       x = \"Week\",\n       y = \"Net Movement\") +\n  geom_vline(xintercept = (cutoff_date-3.5),linetype='dashed')+\n  scale_fill_manual(values = c('maroon','darkgreen'), labels = c('A','B'))+\n  #scale_x_date(date_labels = \"%Y-%m\", date_breaks = \"1 month\") +\n  theme_classic()\n```\n\nFinally we can estimate counts for each species in our sonar data.\n\n```{r,cutoff_estimate}\nN_est<-daily_sonar%>%\n  group_by(predicted_species)%>%\n  summarise(total=sum(Net_Movement))\n```\n\nWith the above snippet we can see that our final estimates of sonar\ncounts are `r N_est[1,2]` for species A and `r N_est[2,2]` for species\nB. We know that our simulated data had a count of `r sum(daily_sonar$species==\"A\")` for\nspecies A and `r sum(daily_sonar$species==\"B\")` for species B, so we had an error rate\nof `r 100*(1-(N_est[1,2]/sum(daily_sonar$species==\"A\")))`%.\n\nThe above method of speciation, while simple, provides a straightforward\napproach for leveraging historical data to infer species composition in\nsonar detection studies. Key assumptions to realize when utilizing this\nmethod are:\n\n-   All fish being speciated are either one of two species.\n\n-   There is no overlap in run timing.\n\n-   Date based threshold of the auxiliary data is representative of the\n    sonar site.\n\n-   Date based threshold used is consistent between years.\n\nReal world systems will likely violate one or more of the above\nassumptions, so the use of this method is likely to bias species\nidentifications and resulting count estimates. Our simulation had an\noverlap in run timing and variation in the distributions that resulted\nin an over-count of species B and an under-count of species A.\n \n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"inseason_cutoff.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.433","editor":"visual","theme":"cosmo","title":"In-season Cutoff","bibliography":["references/references.bib"],"link-citations":true},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}
{
  "hash": "fca8c98008be988fe8973bfc73d0f30f",
  "result": {
    "markdown": "---\ntitle: \"Gaussian Mixed Modelling\"\n\nbibliography: references/references.bib\nlink-citations: TRUE\n---\n\n::: {.cell}\n\n:::\n\n\n# Gaussian Mixed model apportionment\n\nAn alternative to the logistic models is called a \"Guassian Mixed Model\"\n(GMM). The logistic regression models used previously involve assigning\nindividuals to one species or another based on whether or not the\nprobability exceeds a threshold. When their is a lot of overlap in\ndistribution of lengths or dates, this species assignment method is\nsubject to bias, especially when proportions of a given species are\nrelatively one-sided [@Fleischman2003]. While a GMM approach may not be\nas easily interpretable as the logistic regressions, and rely on an\nassumption of normality, they can handle uncertainty better, especially\nwhen dealing with significant overlap in species length and timing\ndistributions.\n\nA general equation of the GMM utilized is:\n\n$$f(x,y)=\\sum_{k=1}^{K}\\pi_k*N((x,y)|\\mu_k,\\sigma_k^2) $$\n\nThe above gives the probability density function of a dataset as a\nweighted sum of multiple Gaussian (normal) distributions. Each component\n$k$ represents a cluster in the data,of which there are a total of $K$,\nfor our example we expect 3 clusters for species \"A\", \"B\", and \"C\".\n$(x,y)$ are the observed data points (in our case length and date), and\n$\\pi_k$ is the mixing proportion for component $k$, which all sum to 1.\n$N((x,y)|\\mu_k,\\sigma_k^2)$ represents the Gaussian distribution for\neach of the $k$-th components with a mean of $\\mu_k$ and a variance of\n$\\sigma_k^2$.\n\nFor our demonstration, we can use the same auxiliary and sonar data sets\nthat we've already simulated before, and see how the GMM compares to the\nlogistic regression methods we've used. We've already seen the\ndistributions of these data, but we can visualize the 2D distribution as\nwell:\n\n\n::: {.cell warnings='false' messages='false'}\n::: {.cell-output-display}\n![Plot of the 2D distributions of auxiliary data with species identities.](gmm_files/figure-html/unnamed-chunk-2-1.png){width=480}\n:::\n:::\n\n\nWith the above plot we can see distinct clusters of dates and lengths,\nwith some overlap between species.\n\nWe'll start by loading the `mclust` package to utilize their `Mclust()`\ncall to run a GMM on our data, and testing the model on the auxiliary\ndata in the same way we've used in before. Note that in this for-loop,\ninstead of using the predict function to set a given species ID based on\na probability threshold, I'm estimating the abundance by summing the\ntotal probability for each species and using that as our abundance\nestimate.\n\n\n::: {.cell warnings='false' messages='false'}\n\n```{.r .cell-code}\nset.seed(Sys.time()) #reset seed\niterations=100\nresults<-data.frame()\ngmm_data<-select(aux_data,length,date,Flow_cfs,species)\n#note here that the Mclust requires date in a numeric format\ngmm_data$num_date<-as.numeric(gmm_data$date) \nfor(i in 1:iterations){\n  train_index <- createDataPartition(gmm_data$species, p = 0.7, list = FALSE) \n  train_data <- gmm_data[train_index, ]\n  test_data <- gmm_data[-train_index, ]\n  \n  Ntrue_A<-sum(test_data$species==\"A\")\n  Ntrue_B<-sum(test_data$species==\"B\")\n  Ntrue_C<-sum(test_data$species==\"C\")\n  \n  #Fit a Gaussian Mixture Model to the training data \n  model_iter <- Mclust(train_data[, c(\"length\", \"num_date\")], G=3)\n  \n  #summary(model_iter)\n  # Predict species for the test data based on the trained model\n  predictions <- predict(model_iter, test_data[, c(\"length\", \"num_date\")])\n  test_data$species_predicted <- factor(predictions$classification,\n                                        levels = 1:3, labels = c(\"A\",\"B\",\"C\"))\n  \n  accuracy <- sum(test_data$species_predicted == \n                    test_data$species)/nrow(test_data)\n  \n  #Change in abundance estimate:\n  #here I can sum the probability for each classification to \n  #estimate total abundance\n  #instead of using the threshold classification method\n  Nest_A<-sum(predictions$z[,1])\n  Nest_B<-sum(predictions$z[,2])\n  Nest_C<-sum(predictions$z[,3])\n\n  error_A <- abs(Nest_A - Ntrue_A)\n  error_B <- abs(Nest_B - Ntrue_B)\n  error_C <- abs(Nest_C - Ntrue_C)\n\n  rel_error_A <- error_A / Ntrue_A\n  rel_error_B <- error_B / Ntrue_B\n  rel_error_C <- error_C / Ntrue_C\n  \n  MAPE <- mean(c(rel_error_A, rel_error_B, rel_error_C)) * 100\n  d<-data.frame(\"accuracy\"=accuracy,\"MAPE\"=MAPE)\n  \n  results<-results%>%rbind(d)\n}\n```\n:::\n\n\nBased on the above model training and iterative testing, we see our\nmodel predicted the species of our test data with an average accuracy of\n0.886, and estimated species abundance\nwith an average error of 9.205.\n\nNow we can retrain our model using the entire auxiliary data set, and\nuse it to predict species counts for our sonar_data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_3<-Mclust(gmm_data[, c(\"length\", \"num_date\")], G=3)\n#note here that the Mclust requires date in a numeric format\nsonar_data$num_date<-as.numeric(sonar_data$date)\npredictions <- predict(model_3, sonar_data[, c(\"length\", \"num_date\")])\nsonar_data$species_predicted <- factor(predictions$classification,\n                                       levels = 1:3, labels = c(\"A\",\"B\",\"C\"))\n```\n:::\n\n\nWe can plot our predicted species to see if the clustering generally\nfits that of our auxiliary data.\n\n\n::: {.cell warnings='false' messages='false'}\n::: {.cell-output-display}\n![Plot of the 2D distributions of sonar data with predicted species identities.](gmm_files/figure-html/unnamed-chunk-4-1.png){width=480}\n:::\n:::\n\n\nNow, instead of using the assigned species values, we'll use the\nprobability each fish is a given species, which will give us a total\nestimate of abundance. If we look at the `predictions$z` we see a record\nfor each observation that gives the probability it is one of the three\nclasses based on the model predictions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(predictions$z)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             1            2            3\n[1,] 0.9999889 1.106059e-05 3.037456e-15\n[2,] 0.8699173 1.300606e-01 2.211427e-05\n[3,] 0.9484408 4.313523e-02 8.423995e-03\n[4,] 0.9992204 7.795544e-04 8.353405e-10\n[5,] 0.9856517 1.434752e-02 7.578460e-07\n[6,] 0.9998748 1.251561e-04 3.517768e-08\n```\n:::\n:::\n\n\nWe can take the sum of each column to estimate the abundance of each\nspecies here:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNest_A<-round(sum(predictions$z[,1]))\nNest_B<-round(sum(predictions$z[,2]))\nNest_C<-round(sum(predictions$z[,3]))\n```\n:::\n\n\nOur estimates of abundance in this example are 1082 for species A,\n741 for species B, and 327 for species C.\n\n## *Estimating uncertainty*\n\nAgain we can replicate our bootstrapping methods we used to estimate\nuncertainty in prior methods.\n\n\n::: {.cell warnings='false'}\n\n```{.r .cell-code}\n#bootstrapping boogie\niterations<-100\nresults<-data.frame()\n\nfor(j in 1:iterations){\n  d <- sonar_data[sample(nrow(sonar_data), replace = TRUE), ]\n  predictions <- predict(model_3, d[, c(\"length\", \"num_date\")])\n  d$species_predicted <- factor(predictions$classification,\n                                       levels = 1:3, labels = c(\"A\",\"B\",\"C\"))\n  \n  N_A<-sum(predictions$z[,1])\n  N_B<-sum(predictions$z[,2])\n  N_C<-sum(predictions$z[,3])\n  iter<-data.frame('iteration'=j,\"A\"=N_A[1],\"B\"=N_B[1],\"C\"=N_C[1])\n  results<-results%>%rbind(iter)\n}\n\n#iteration total estimates\niter_totals<-results%>%\n  group_by(iteration)%>%\n  dplyr::summarise(A=sum(A),\n                   B=sum(B),\n                   C=sum(C))\n\n#bounds\nA_stats <- quantile(iter_totals$A, probs = c(0.025, 0.975))\nB_stats <- quantile(iter_totals$B, probs = c(0.025, 0.975))\nC_stats <- quantile(iter_totals$C, probs = c(0.025, 0.975))\n```\n:::\n\n\nThe above results show that our estimate of total abundance of species A\nin our sonar counts is 1082 with 95% CI \\[1042,\n1125\\], a count of 741 with 95% CI\n\\[702, 785\\] for species B, and\na count of 327 with 95% CI \\[295,\n355\\] for species C.\n",
    "supporting": [
      "gmm_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}